/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{debounce as _0x15ae83}from'lodash-es';import{Plugin as _0x5ae7e4}from'ckeditor5/src/core';import{DomEmitterMixin as _0x74dd8a,logWarning as _0x359756}from'ckeditor5/src/utils';import{Users as _0x386a59}from'ckeditor5-collaboration/src/collaboration-core';import _0xc3ca3b from'../realtimecollaborativeediting/realtimecollaborationclient';import _0x252c20 from'../realtimecollaborativeediting/websocketgateway';import _0x3715bf from'../realtimecollaborativeediting/sessions';import _0x1f9ee6 from'@ckeditor/ckeditor-cloud-services-collaboration/src/users/user';import tt from'@ckeditor/ckeditor-cloud-services-collaboration/src/revision-history/revisionhistoryservice';export default class v extends _0x5ae7e4{static get['requires'](){return[_0x252c20,_0xc3ca3b,'RevisionTracker',_0x3715bf,_0x386a59];}async['init'](){this['_lastRequestId']=null,this['_revisionTracker']=this['editor']['plugins']['get']('RevisionTracker');const _0x32e968=this['editor']['plugins']['get'](_0xc3ca3b),_0x4d25d6=_0x32e968['serverHistory'],_0x444710=this['editor']['plugins']['get'](_0x252c20);_0x444710['addToReconnectionStack'](this);const _0x29924d=this['editor']['config']['get']('collaboration.channelId');this['_revisionHistoryService']=new v['RevisionHistoryService'](_0x29924d),this['_revisionTracker']['setSource']({'history':_0x4d25d6,'getLatestVersion':()=>this['_getLatestVersion'](),'getCurrentRevisionId':()=>_0x32e968['sessionId']}),this['_revisionTracker']['adapter']={'getRevision':async({revisionId:_0x43ac05})=>(await this['_waitForServiceReady'](),await this['_revisionHistoryService']['getRevision'](_0x43ac05)),'updateRevisions':async _0x2b43b5=>{await this['_waitForServiceReady']();const _0x238776=this['_revisionTracker']['currentRevision'];for(const _0x4b5422 of _0x2b43b5)_0x4b5422['id']===_0x238776['id']&&(_0x4b5422['isEmptyCurrent']=_0x4b5422['fromVersion']===_0x4b5422['toVersion']);this['_revisionHistoryService']['updateRevisions'](_0x2b43b5,this['_lastRequestId'])['then'](_0x5aaab6=>{this['_lastRequestId']=_0x5aaab6;})['catch'](_0x257dd6=>{if(!(it(_0x257dd6)||'400'===_0x257dd6['code']&&void 0x0!==_0x257dd6['data']['wrongRequestId']))throw _0x257dd6;for(const _0x2f198f of _0x2b43b5){!this['_revisionTracker']['repository']['getRevision'](_0x2f198f['id'])||this['_revisionTracker']['_bufferUpdate'](_0x2f198f['id'],_0x2f198f,!0x1);}if(it(_0x257dd6))throw _0x257dd6;});}},this['listenTo'](this['_revisionHistoryService'],'revisionsUpdated',(_0x2e65a8,{revisionsData:_0x42486e,requestId:_0x495851})=>{Math['max'](..._0x42486e['map'](_0x2af51d=>_0x2af51d['toVersion']))>this['_getLatestVersionFromServerOperations']()-0x1?this['_getLatestVersion']()['then'](()=>{this['_handleRevisionsUpdate'](_0x42486e,_0x495851);}):this['_handleRevisionsUpdate'](_0x42486e,_0x495851);});const {revisions:_0x526bec,requestId:_0x55c586}=await this['_revisionHistoryService']['connect'](_0x444710['connection']);this['_lastRequestId']=_0x55c586,await this['_fetchMissingUsers'](_0x526bec);for(const _0x37aac4 of _0x526bec)this['_revisionTracker']['addRevisionData'](_0x37aac4);if(_0x526bec['length']>0x0){const _0x2edd00=this['_revisionTracker']['repository']['getRevision'](0x0),_0x1d5ee7=await this['_revisionTracker']['getRevisionDocumentData'](_0x2edd00);this['_isEditorInitialDataDifferent'](this['editor'],_0x1d5ee7)&&(_0x359756('editor-initial-data-replaced-with-revision-data'),this['editor']['config']['set']('initialData',_0x1d5ee7));}this['listenTo'](_0x32e968,'change:_isConnected',(_0x502ca1,_0x5b39a2,_0x56bb99)=>{_0x56bb99&&(this['_oldOffset']=_0x32e968['_offset'],_0x502ca1['off']());}),this['editor']['plugins']['has']('Autosave')||this['_initForDocumentStorage'](),this['_revisionTracker']['bind']('isEnabled')['to'](_0x444710,'state',_0x161ff8=>'connected'===_0x161ff8);}async['reconnect'](){const _0x38cdfe=this['editor']['plugins']['get'](_0x252c20),_0x433810=this['editor']['plugins']['get'](_0xc3ca3b),_0x13453a=async()=>{const _0x50a6ed=this['_revisionTracker']['currentRevision'],_0x3d0c00=_0x50a6ed['id'],_0x466b65=_0x3d0c00!==_0x433810['sessionId'];if(_0x466b65){const _0x394e34=_0x433810['_offset']-this['_oldOffset'],_0x31a85e=this['_getLatestVersionFromServerOperations']();this['_revisionTracker']['_revisionDataBuilder']['reInit']();if(_0x50a6ed['toVersion']+_0x394e34!==_0x31a85e){const _0x4af39b=_0x50a6ed['fromVersion']+_0x394e34,_0x4f4946=this['editor']['plugins']['get']('Users'),_0x1bede5=this['_revisionTracker']['buildRevisionData']({'currentRevision':_0x50a6ed,'from':_0x4af39b,'to':_0x31a85e});_0x1bede5['id']=_0x50a6ed['id'];const _0x2c0afd=_0x1bede5['authorsIds']['map'](_0xc6420d=>_0x4f4946['getUser'](_0xc6420d));_0x50a6ed['_update']({..._0x1bede5,'authors':_0x2c0afd},!0x0),this['_revisionTracker']['_bufferUpdate'](_0x50a6ed['id'],_0x1bede5,!0x0);}this['_revisionTracker']['_startingVersion']=_0x31a85e,(_0x50a6ed['toVersion']===_0x50a6ed['fromVersion']&&!this['_revisionTracker']['_bufferedUpdates']['has'](_0x3d0c00)&&this['_revisionTracker']['repository']['_revisions']['remove'](_0x3d0c00),this['_revisionTracker']['_createCurrentRevision'](_0x31a85e));}const {revisions:_0x56fc39,requestId:_0x4cf68a}=await this['_revisionHistoryService']['reconnect'](_0x38cdfe['connection'],this['_lastRequestId']);_0x466b65&&_0x56fc39['length']>0x0?_0x433810['_handleReconnectionError']():(await this['_fetchMissingUsers'](_0x56fc39),this['_handleRevisionsUpdate'](_0x56fc39,_0x4cf68a),this['_revisionTracker']['sendBufferedUpdates']());};return _0x433810['_isConnected']?_0x13453a():new Promise((_0x45ca49,_0x27da9b)=>{_0x433810['once']('change:_isConnected',()=>{_0x13453a()['then'](_0x45ca49)['catch'](_0x27da9b);});});}['destroy'](){this['_domEmitter']&&this['_domEmitter']['stopListening'](),super['destroy']();}async['_waitForServiceReady'](){this['_revisionHistoryService']['isConnected']||await new Promise(_0x42dbff=>{this['listenTo'](this['_revisionHistoryService'],'connected',_0x3985ad=>{_0x3985ad['off'](),_0x42dbff();});});}['_getLatestVersionFromServerOperations'](){const _0xe9bb2=this['editor']['plugins']['get'](_0xc3ca3b)['serverHistory']['_operations'];for(let _0x2e44b0=_0xe9bb2['length']-0x1;_0x2e44b0>=0x0;_0x2e44b0--)if('marker'!==_0xe9bb2[_0x2e44b0]['type']||_0xe9bb2[_0x2e44b0]['affectsData'])return _0xe9bb2[_0x2e44b0]['baseVersion']+0x1;}['_isEditorInitialDataDifferent'](_0x49217f,_0x33a557){let _0x302675=_0x49217f['config']['get']('initialData');if(void 0x0===_0x302675)return!0x1;'string'==typeof _0x302675&&(_0x302675={'main':_0x302675});for(const _0x346304 of Object['keys'](_0x33a557))if(_0x302675[_0x346304]!==_0x33a557[_0x346304])return!0x0;return!0x1;}['_getLatestVersion'](){const _0x1767dc=this['editor']['plugins']['get'](_0xc3ca3b);return new Promise(_0x29bf0c=>{_0x1767dc['_isPendingUpdate']?_0x1767dc['once']('change:_isPendingUpdate',()=>{_0x29bf0c(this['_getLatestVersionFromServerOperations']());}):_0x29bf0c(this['_getLatestVersionFromServerOperations']());});}['_initForDocumentStorage'](){this['_domEmitter']=Object['create'](_0x74dd8a);const t=this['editor']['t'],_0x1a9656=this['editor']['plugins']['get']('PendingActions');let _0x528a6e=null;const _0x2ce846=_0x15ae83(()=>{this['_revisionTracker']['update']()['finally'](()=>{_0x528a6e&&(_0x1a9656['remove'](_0x528a6e),_0x528a6e=null);});},0x1f4);this['listenTo'](this['editor'],'ready',()=>{this['listenTo'](this['editor']['model']['document'],'change:data',(_0x1ff5bf,_0x44c3f8)=>{_0x44c3f8['isLocal']&&(_0x528a6e||(_0x528a6e=_0x1a9656['add'](t({'string':'Unsaved\x20change\x20in\x20revision\x20history.','id':'PENDING_ACTION_REVISION_HISTORY'}))),_0x2ce846());});}),this['_domEmitter']['listenTo'](window,'beforeunload',(_0x56a524,_0x14d011)=>{_0x1a9656['hasAny']&&(_0x14d011['returnValue']=_0x1a9656['first']['message']);});}['_handleRevisionsUpdate'](_0x370305,_0x22aac6){const _0x598126=this['_revisionTracker']['repository'];this['_lastRequestId']=_0x22aac6;for(const _0x108e51 of _0x370305){const _0x1bfc70=_0x598126['getRevision'](_0x108e51['id']);if(_0x1bfc70){if((_0x108e51['fromVersion']||_0x108e51['toVersion'])&&(_0x108e51['diffData']=null),_0x1bfc70===this['_revisionTracker']['currentRevision']){const _0x8e45d4=Math['max'](_0x1bfc70['toVersion'],_0x108e51['toVersion']),_0x4b097c=Math['max'](_0x1bfc70['fromVersion'],_0x108e51['fromVersion']);let _0x2bbbc9;_0x1bfc70['toVersion']===_0x108e51['toVersion']&&_0x1bfc70['fromVersion']===_0x108e51['fromVersion']?(_0x2bbbc9=!0x0,this['_preventResendingRevisionData'](_0x108e51)):_0x108e51['toVersion']===_0x8e45d4&&_0x108e51['fromVersion']===_0x4b097c?_0x2bbbc9=!0x1:(_0x1bfc70['toVersion']===_0x8e45d4&&_0x1bfc70['fromVersion']===_0x4b097c||this['_fixRevision']({'revision':_0x1bfc70,'from':_0x4b097c,'to':_0x8e45d4}),_0x2bbbc9=!0x0),_0x2bbbc9&&(delete _0x108e51['fromVersion'],delete _0x108e51['toVersion'],delete _0x108e51['diffData'],delete _0x108e51['createdAt'],delete _0x108e51['authorsIds']);}this['_revisionTracker']['setRevisionData'](_0x108e51),this['_preventResendingRevisionData'](_0x108e51);}else this['_revisionTracker']['addRevisionData'](_0x108e51);}const _0x2fdf29=_0x598126['getRevisions']();_0x2fdf29['reverse']();for(let _0x596182=0x0;_0x596182<_0x2fdf29['length']-0x1;_0x596182++){const _0x41c8cb=_0x2fdf29[_0x596182],_0x251517=_0x2fdf29[_0x596182+0x1];if(_0x41c8cb['fromVersion']<_0x251517['toVersion']){const _0x2b24ba=_0x251517['toVersion'];this['_fixRevision']({'revision':_0x41c8cb,'from':_0x2b24ba});}}}['_fixRevision']({revision:_0x4803b5,from:_0x1b82db,to:_0x1c17eb}={}){const _0x1953dc=this['editor']['plugins']['get']('Users'),_0x35c50f=this['_revisionTracker']['buildRevisionData']({'revision':_0x4803b5,'from':_0x1b82db,'to':_0x1c17eb});_0x35c50f['authors']=_0x35c50f['authorsIds']['map'](_0x4cc73b=>_0x1953dc['getUser'](_0x4cc73b)),_0x4803b5['_update'](_0x35c50f);}['_preventResendingRevisionData'](_0x14385f){const _0x5e4000={};_0x5e4000['id']=_0x14385f['id'];for(const _0x10048e of Object['keys'](_0x14385f))'id'!==_0x10048e&&(_0x5e4000[_0x10048e]=void 0x0);this['_revisionTracker']['_bufferUpdate'](_0x5e4000['id'],_0x5e4000,!0x0);}['_fetchMissingUsers'](_0x21714f){const _0x32b6ec=this['editor']['plugins']['get'](_0x386a59),{connection:_0x242a52}=this['editor']['plugins']['get'](_0x252c20),_0x35da81=new Set();for(const _0x4de8d3 of _0x21714f){for(const _0x26aeae of _0x4de8d3['authorsIds'])_0x1ed298(_0x26aeae);_0x4de8d3['creatorId']&&_0x1ed298(_0x4de8d3['creatorId']);}return Promise['all'](Array['from'](_0x35da81,async _0x22a85b=>{const _0x4219d7=await _0x1f9ee6['get'](_0x242a52,_0x22a85b);_0x32b6ec['getUser'](_0x22a85b)||_0x32b6ec['addUser'](_0x4219d7);}));function _0x1ed298(_0x8be8c3){_0x32b6ec['getUser'](_0x8be8c3)||_0x35da81['add'](_0x8be8c3);}}}function it(_0x4c68ef){return _0x4c68ef['message']['startsWith']('cloud-services-internal-error:\x20Revision\x20History\x20Service\x20is\x20not\x20connected.')||_0x4c68ef['message']['startsWith']('cloud-services-internal-error:\x20Not\x20connected.')||_0x4c68ef['message']['startsWith']('cloud-services-internal-error:\x20Request\x20timeout.');}v['RevisionHistoryService']=tt;