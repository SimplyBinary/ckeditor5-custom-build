/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Plugin as _0x5e89db}from'ckeditor5/src/core';import{Collection as Ct}from'ckeditor5/src/utils';import{Model as bt,SplitButtonView as Tt,createDropdown as At,addListToDropdown as xt}from'ckeditor5/src/ui';import{Users as _0x3b50b6,getDateTimeFormatter as Et,getMarkerDomElement as St}from'ckeditor5-collaboration/src/collaboration-core';import _0x3fab49 from'./trackchangesediting';import vt from'./ui/suggestioncontroller';import Nt from'./ui/view/suggestionthreadview';import It from'../theme/icons/track-changes.svg';import{debounce as Dt}from'lodash-es';export default class m extends _0x5e89db{static get['requires'](){return[_0x3fab49,_0x3b50b6,'CommentsRepository','Annotations','EditorAnnotations'];}static get['pluginName'](){return'TrackChangesUI';}constructor(_0x1228e6){super(_0x1228e6),this['_suggestionToController']=new Map(),this['_viewToController']=new Map(),this['_debouncedHandlers']=new Map();const _0x2f36bc=this['editor']['config'];_0x2f36bc['define']('trackChanges.SuggestionThreadView',Nt),_0x2f36bc['define']('trackChanges.disableComments',!0x1),this['_disableComments']=_0x2f36bc['get']('trackChanges.disableComments');}['init'](){const _0x2c8a14=this['editor'],_0x37fb78=_0x2c8a14['plugins']['get'](_0x3fab49),_0xea2eab=_0x2c8a14['plugins']['get']('Annotations'),_0xb6310b=_0x2c8a14['plugins']['get']('EditorAnnotations'),_0x5a27f3=_0x2c8a14['plugins']['get']('CommentsRepository');_0x2c8a14['ui']['componentFactory']['add']('trackChanges',_0x301877=>this['_createUIButton'](_0x301877)),_0xb6310b['addSourceCollector'](()=>{const _0x2bde2b=[];for(const [_0x292087,_0x1d68a0]of Array['from'](this['_suggestionToController'])){const _0x1d83e6=_0x292087['getAllAdjacentSuggestions'](),_0x127d60=[];for(const _0x3e0c3e of _0x1d83e6){if(!_0x3e0c3e['isInContent'])continue;if(_0x3e0c3e['isMultiRange']){_0x127d60['push'](..._0x3e0c3e['getRanges']());continue;}const _0xa30520=_0x3e0c3e['getFirstRange']();if(_0x127d60['length']>0x0){const _0xddc0af=_0x127d60[0x0]['getJoined'](_0xa30520);if(_0xddc0af){_0x127d60[0x0]=_0xddc0af;continue;}}_0x127d60['push'](_0xa30520);}_0x2bde2b['push']([_0x1d68a0['view'],_0x127d60]);}return _0x2bde2b;}),this['listenTo'](_0x37fb78,'suggestionLoaded',(_0x45bc41,_0x8ad039)=>{let _0x3cab0b=!0x1;const _0x420916=Dt(_0x2b5334=>{_0x3cab0b||_0x2b5334?_0x3cab0b&&_0x2b5334&&(this['_destroyController'](_0x8ad039),_0xb6310b['refreshSelectedViews'](),_0x3cab0b=!0x1):(this['_initializeController'](_0x8ad039),_0xb6310b['refreshSelectedViews'](),_0x3cab0b=!0x0);},0xa);this['_debouncedHandlers']['set'](_0x8ad039,_0x420916),this['listenTo'](_0x8ad039,'change:previous',(_0x32203c,_0x499b6d,_0x245565,_0x356454)=>{_0x8ad039['isInContent']&&(null==_0x245565?(this['_updateController'](_0x356454['head']),_0x420916(!0x1)):(this['_updateController'](_0x245565['head']),_0x420916(!0x0)));}),null===_0x8ad039['previous']?_0x420916(!0x1):this['_updateController'](_0x8ad039['head']);}),this['listenTo'](_0x37fb78,'suggestionUnloaded',(_0x27d8d4,_0x371a13,_0x5cdcbb)=>{this['stopListening'](_0x371a13,'change:previous'),this['_debouncedHandlers']['get'](_0x371a13)['cancel'](),this['_debouncedHandlers']['delete'](_0x371a13);const _0xe7c268=_0x5cdcbb?_0x5cdcbb['head']:_0x371a13,_0x1c2284=this['_suggestionToController']['get'](_0xe7c268);null!==_0x5cdcbb&&this['_updateController'](_0xe7c268),null===_0x5cdcbb&&_0x1c2284&&this['_destroyController'](_0x371a13);}),this['listenTo'](_0x37fb78,'suggestionChanged',(_0x1e68ab,_0x5dc833)=>{this['_updateController'](_0x5dc833);}),this['listenTo'](_0xea2eab,'change:activeAnnotations',(_0x403884,_0x1cf42f,_0x604904)=>{const _0x206fd9=Array['from'](_0x604904,_0x5c5a03=>_0x5c5a03['innerView'])['filter'](_0x26090f=>this['_viewToController']['has'](_0x26090f)),_0x4027b7=[];for(const _0x20ea47 of _0x206fd9){const _0x47d662=this['_viewToController']['get'](_0x20ea47)['model']['getAllAdjacentSuggestions']();_0x4027b7['push'](..._0x47d662['reduce']((_0x1d8853,_0x8c610)=>[..._0x1d8853,..._0x8c610['getMarkerNames']()],[]));}_0x37fb78['activeMarkers']=_0x4027b7;}),this['listenTo'](_0x5a27f3,'addComment',(_0x2726fd,{threadId:_0x4dd89c,isFromAdapter:_0x4b4219})=>{if(_0x4b4219||!_0x37fb78['hasSuggestion'](_0x4dd89c))return;const _0x2a5da1=_0x37fb78['getSuggestion'](_0x4dd89c);this['_suggestionToController']['get'](_0x2a5da1)['view']['focus']();},{'priority':'lowest'});}['_createUIButton'](_0x52ca0e){const _0x5e6349=At(_0x52ca0e,Tt),_0x255450=this['editor']['commands']['get']('trackChanges'),{t:t}=this['editor'];_0x5e6349['buttonView']['set']({'tooltip':t('Track\x20changes'),'label':t('Track\x20changes'),'icon':It}),_0x5e6349['buttonView']['bind']('isOn')['to'](_0x255450,'value'),_0x5e6349['buttonView']['on']('execute',()=>_0x255450['execute']());const _0x4c5a83=new Ct(),_0x56c198=[{'type':'switchbutton','model':{'withText':!0x0,'label':t('Track\x20changes'),'commandName':'trackChanges'}},{'type':'separator'},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20suggestions'),'commandName':'acceptAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20selected\x20suggestions'),'commandName':'acceptSelectedSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20suggestions'),'commandName':'discardAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20selected\x20suggestions'),'commandName':'discardSelectedSuggestions'}}];for(const _0x17d5c3 of _0x56c198){const _0x17655c={'type':_0x17d5c3['type']};if(_0x17d5c3['model']){const _0x3feae1=new bt(_0x17d5c3['model']),_0x4a301a=this['editor']['commands']['get'](_0x3feae1['commandName']);_0x3feae1['bind']('isOn','isEnabled')['to'](_0x4a301a,'value','isEnabled'),_0x17655c['model']=_0x3feae1;}_0x4c5a83['add'](_0x17655c);}xt(_0x5e6349,_0x4c5a83);const _0xcde064=_0x56c198['filter'](_0x5d0124=>null!=_0x5d0124['model'])['map'](_0x590b9b=>this['editor']['commands']['get'](_0x590b9b['model']['commandName']));return _0x5e6349['buttonView']['actionView']['unbind']('isEnabled'),_0x5e6349['buttonView']['arrowView']['unbind']('isEnabled'),_0x5e6349['buttonView']['actionView']['bind']('isEnabled')['to'](_0x255450,'isEnabled'),_0x5e6349['buttonView']['arrowView']['bind']('isEnabled')['toMany'](_0xcde064,'isEnabled',(..._0x3b1e32)=>_0x3b1e32['some'](_0x50a738=>_0x50a738)),_0x5e6349['on']('execute',_0x3822d9=>this['editor']['execute'](_0x3822d9['source']['commandName'])),_0x5e6349;}['_initializeController'](_0xca7a5e){const _0x383f48=this['editor'],_0x47f409=_0x383f48['config'],_0x729e09=_0x383f48['plugins']['get']('Annotations'),_0x3d8a11=_0x383f48['plugins']['get']('CommentsRepository'),_0x48f11f=_0xca7a5e['getAllAdjacentSuggestions']()['filter'](_0x4fc217=>_0x4fc217['isInContent']),_0x3ba3a7=_0x383f48['plugins']['get'](_0x3b50b6)['me'],_0x29dde8=_0x383f48['commands']['get']('acceptSuggestion'),_0x5c072f=_0x383f48['commands']['get']('discardSuggestion'),_0x51a8a5=_0x47f409['get']('trackChanges')['SuggestionThreadView'],{CommentsListView:_0x449d90,CommentThreadInputView:_0x5bc04f}=_0x383f48['plugins']['get']('CommentsUI'),_0x3c8824=new _0x51a8a5(_0x383f48['locale'],_0xca7a5e,_0x3ba3a7,{'disableComments':this['_disableComments'],'editorConfig':_0x47f409['get']('comments.editorConfig'),'maxCommentsWhenCollapsed':_0x47f409['get']('comments.maxCommentsWhenCollapsed'),'maxThreadTotalWeight':_0x47f409['get']('comments.maxThreadTotalWeight'),'maxCommentCharsWhenCollapsed':_0x47f409['get']('comments.maxCommentCharsWhenCollapsed'),'formatDateTime':Et(_0x47f409['get']('locale')),'CommentView':_0x47f409['get']('comments')['CommentView'],'CommentsListView':_0x449d90,'CommentThreadInputView':_0x5bc04f}),_0x26144f=_0x3d8a11['createCommentThreadController'](_0xca7a5e['commentThread'],_0x3c8824),_0x4538e1=new vt(_0xca7a5e,_0x3c8824,_0x29dde8,_0x5c072f,_0x26144f);_0x3c8824['descriptionParts']=_0x383f48['plugins']['get']('TrackChangesEditing')['_descriptionFactory']['getDescriptions'](_0x48f11f),this['_suggestionToController']['set'](_0xca7a5e,_0x4538e1),this['_viewToController']['set'](_0x3c8824,_0x4538e1);const _0x3c9481=_0x729e09['createAnnotationView'](this['editor']['locale'],_0x3c8824);_0x3c9481['bind']('isDirty')['to'](_0x3c8824,'isDirty'),_0x3c9481['bind']('length')['to'](_0x3c8824),_0x3c9481['bind']('type')['to'](_0x3c8824,'type',_0x58086b=>'suggestion-'+_0x58086b);const _0x8ae2db=_0x729e09['createAnnotation']({'view':_0x3c9481,'target':()=>{const _0x23411c=_0x48f11f[0x0]['getFirstMarker']();if(!_0x23411c)return null;const _0x281cb1=_0x23411c['getRange']()['getContainedElement']();return _0x281cb1&&!_0x383f48['editing']['mapper']['toViewElement'](_0x281cb1)?null:St(_0x383f48['editing'],_0x23411c)||null;},'type':()=>'suggestion-'+_0x4538e1['view']['type']});_0x729e09['add'](_0x8ae2db);const _0x32aebd=_0x383f48['plugins']['get']('PendingActions');let _0x29b347;_0x3c8824['on']('change:isDirty',(_0x285c58,_0xe34fd7,_0x327154)=>{if(_0x327154){const t=this['editor']['locale']['t'];_0x29b347=_0x32aebd['add'](t({'string':'Unsaved\x20change\x20in\x20suggestion.','id':'PENDING_ACTION_SUGGESTION'}));}else _0x32aebd['remove'](_0x29b347),_0x29b347=null;});}['_destroyController'](_0x346ccf){const _0x2842ff=this['editor']['plugins']['get']('Annotations'),_0x47f700=this['_suggestionToController']['get'](_0x346ccf),_0x5e15e9=_0x47f700['view'],_0x435c00=_0x2842ff['getByInnerView'](_0x5e15e9);_0x435c00&&_0x2842ff['remove'](_0x435c00),this['_suggestionToController']['delete'](_0x346ccf),this['_viewToController']['delete'](_0x5e15e9),_0x47f700['destroy'](),_0x5e15e9['destroy']();}['_updateController'](_0x2b130a){if(!_0x2b130a['isInContent']||!this['_suggestionToController']['has'](_0x2b130a))return;const _0xe9c78a=this['editor']['plugins']['get']('TrackChangesEditing'),_0x3e12e4=this['_suggestionToController']['get'](_0x2b130a),_0x5af5be=_0x2b130a['getAllAdjacentSuggestions']();_0x3e12e4['view']['descriptionParts']=_0xe9c78a['_descriptionFactory']['getDescriptions'](_0x5af5be);}['destroy'](){super['destroy']();for(const _0x5687ee of this['_suggestionToController']['keys']())this['_destroyController'](_0x5687ee);for(const _0x558e54 of this['_debouncedHandlers']['values']())_0x558e54['cancel']();this['_debouncedHandlers']['clear']();}}