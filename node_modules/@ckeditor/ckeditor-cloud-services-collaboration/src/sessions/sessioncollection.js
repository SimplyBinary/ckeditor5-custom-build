/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x47fe94){return _0x47fe94&&_0x47fe94['__esModule']?_0x47fe94:{'default':_0x47fe94};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),sessions_1=require('./sessions'),user_1=__importDefault(require('./../users/user')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),sessionsconnectresponse_1=__importDefault(require('./responses/sessionsconnectresponse')),sessionsconnectmessage_1=__importDefault(require('./messages/sessionsconnectmessage')),socketconnectmessage_1=__importDefault(require('./messages/socketconnectmessage')),socketdisconnectmessage_1=__importDefault(require('./messages/socketdisconnectmessage')),messagescompressor_1=__importDefault(require('./../messagescompressor'));class SessionCollection extends utils_1['Collection']{constructor(_0x402089,_0x3929ea){super({'idProperty':'id'}),this['_id']=_0x402089,this['_sessionType']=_0x3929ea,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x4a000c){this['_wsGateway']=_0x4a000c,this['stopListening'](_0x4a000c,'change:state');const _0x471eca=new sessionsconnectmessage_1['default'](this['_id'],this['_sessionType']);let _0x587e43;try{const _0x3ba214=await this['_wsGateway']['_sendRequest'](sessions_1['_SERVICE'],sessionsconnectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x471eca));_0x587e43=messagescompressor_1['default']['decode'](_0x3ba214,sessionsconnectresponse_1['default']);}catch(_0x43776c){_0x587e43=new sessionsconnectresponse_1['default'](this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x587e43['channel'],this['_sessionType']);const _0x4eeb02=await async function(_0x120928,_0x5cbb13){const _0x11507d=_0x5cbb13['map'](_0x5dd6dd=>_0x5dd6dd['userId']),_0x483d95=_0x11507d['length']?await user_1['default']['getMany'](_0x120928,_0x11507d):[];return _0x5cbb13['map'](_0xa37d13=>{const _0x2375d8={'id':_0xa37d13['id'],'role':_0xa37d13['role'],'permissions':_0xa37d13['permissions']};return _0x2375d8['user']=_0xa37d13['userId']&&_0x483d95['find'](_0x8ccf90=>_0x8ccf90['id']===_0xa37d13['userId'])||new user_1['default'](),_0x2375d8;});}(this['_wsGateway'],_0x587e43['sockets']);for(const _0x2d2293 of _0x4eeb02)super['add'](_0x2d2293);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x1a13b7,_0x215bcd,_0x340b28)=>this['_onWsGatewayStateChange'](_0x340b28),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x3f785b=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x3f785b&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x3f785b&&this['stopListening']();}}['add'](_0x466182,_0x5966c6){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x4bbded){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x396cc6,_0x1fac15,_0xcd72fa){this['_channel']=_0x396cc6['_getChannel'](_0xcd72fa,_0x1fac15),this['_channel']&&(this['_addHandler'](this['_channel'],socketconnectmessage_1['default']['TYPE'],async _0x175b02=>{const _0x534dce=messagescompressor_1['default']['decode'](_0x175b02,socketconnectmessage_1['default']);if(-0x1===this['getIndex'](_0x534dce['id'])){const _0x50df2f={'id':_0x534dce['id'],'role':_0x534dce['role'],'permissions':_0x534dce['permissions']};_0x534dce['userId']&&(_0x50df2f['user']=await user_1['default']['get'](_0x396cc6,_0x534dce['userId'])),super['add'](_0x50df2f);}}),this['_addHandler'](this['_channel'],socketdisconnectmessage_1['default']['TYPE'],_0x1756ac=>{const _0x24ffad=messagescompressor_1['default']['decode'](_0x1756ac,socketdisconnectmessage_1['default']);-0x1!==this['getIndex'](_0x24ffad['id'])&&super['remove'](_0x24ffad['id']);}));}async['_onWsGatewayStateChange'](_0x38a204){_0x38a204===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x38a204===websocketgateway_1['default']['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x48796d;for(this['_isRunning']=!0x0;_0x48796d=this['_eventsQueue']['shift']();){const _0x5e2de3=this['_handlers']['get'](_0x48796d['eventName']);_0x5e2de3&&await _0x5e2de3(_0x48796d['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x11cfb4,_0x254e55,_0x480eae){const _0x5d8cf5=_0x11cfb4['getEventName'](_0x254e55,!0x0);this['listenTo'](_0x11cfb4,_0x5d8cf5,async(_0x3307e7,_0x2b8c20)=>{const _0x3aea9d=_0x3307e7['name'];this['_eventsQueue']['push']({'eventName':_0x3aea9d,'data':_0x2b8c20}),await this['_runQueue']();}),this['_handlers']['set'](_0x5d8cf5,_0x480eae);}}exports['default']=SessionCollection;