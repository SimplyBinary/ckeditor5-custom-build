/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x396f9c){return _0x396f9c&&_0x396f9c['__esModule']?_0x396f9c:{'default':_0x396f9c};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),sessions_1=require('./sessions'),user_1=__importDefault(require('./../users/user')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),sessionsconnectresponse_1=__importDefault(require('./responses/sessionsconnectresponse')),sessionsconnectmessage_1=__importDefault(require('./messages/sessionsconnectmessage')),socketconnectmessage_1=__importDefault(require('./messages/socketconnectmessage')),socketdisconnectmessage_1=__importDefault(require('./messages/socketdisconnectmessage')),messagescompressor_1=__importDefault(require('./../messagescompressor'));class SessionCollection extends utils_1['Collection']{constructor(_0x2e3e4e,_0x33fa34){super({'idProperty':'id'}),this['_id']=_0x2e3e4e,this['_sessionType']=_0x33fa34,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x153e23){this['_wsGateway']=_0x153e23,this['stopListening'](_0x153e23,'change:state');const _0x6dfe4a=new sessionsconnectmessage_1['default'](this['_id'],this['_sessionType']);let _0xbdc8d9;try{const _0x166b89=await this['_wsGateway']['_sendRequest'](sessions_1['_SERVICE'],sessionsconnectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x6dfe4a));_0xbdc8d9=messagescompressor_1['default']['decode'](_0x166b89,sessionsconnectresponse_1['default']);}catch(_0x50a3be){_0xbdc8d9=new sessionsconnectresponse_1['default'](this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0xbdc8d9['channel'],this['_sessionType']);const _0x12c5f3=await async function(_0x4b522e,_0x50b1ea){const _0x2fe3dc=_0x50b1ea['map'](_0x59c6c3=>_0x59c6c3['userId']),_0x3c5b0f=_0x2fe3dc['length']?await user_1['default']['getMany'](_0x4b522e,_0x2fe3dc):[];return _0x50b1ea['map'](_0x3a2e6f=>{const _0x5d831b={'id':_0x3a2e6f['id'],'role':_0x3a2e6f['role'],'permissions':_0x3a2e6f['permissions']};return _0x5d831b['user']=_0x3a2e6f['userId']&&_0x3c5b0f['find'](_0x3c9480=>_0x3c9480['id']===_0x3a2e6f['userId'])||new user_1['default'](),_0x5d831b;});}(this['_wsGateway'],_0xbdc8d9['sockets']);for(const _0x32f7da of _0x12c5f3)super['add'](_0x32f7da);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x3cacc2,_0x8cde14,_0xfd8e8e)=>this['_onWsGatewayStateChange'](_0xfd8e8e),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x149dd1=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x149dd1&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x149dd1&&this['stopListening']();}}['add'](_0x3aa19d,_0x25b7fd){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x43be0e){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x2dcff4,_0x351f9e,_0x109b44){this['_channel']=_0x2dcff4['_getChannel'](_0x109b44,_0x351f9e),this['_channel']&&(this['_addHandler'](this['_channel'],socketconnectmessage_1['default']['TYPE'],async _0x12c521=>{const _0x5c0d99=messagescompressor_1['default']['decode'](_0x12c521,socketconnectmessage_1['default']);if(-0x1===this['getIndex'](_0x5c0d99['id'])){const _0x5605e3={'id':_0x5c0d99['id'],'role':_0x5c0d99['role'],'permissions':_0x5c0d99['permissions']};_0x5c0d99['userId']&&(_0x5605e3['user']=await user_1['default']['get'](_0x2dcff4,_0x5c0d99['userId'])),super['add'](_0x5605e3);}}),this['_addHandler'](this['_channel'],socketdisconnectmessage_1['default']['TYPE'],_0x3b6d5d=>{const _0xdd4a5b=messagescompressor_1['default']['decode'](_0x3b6d5d,socketdisconnectmessage_1['default']);-0x1!==this['getIndex'](_0xdd4a5b['id'])&&super['remove'](_0xdd4a5b['id']);}));}async['_onWsGatewayStateChange'](_0x50ebdf){_0x50ebdf===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x50ebdf===websocketgateway_1['default']['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x2033fb;for(this['_isRunning']=!0x0;_0x2033fb=this['_eventsQueue']['shift']();){const _0xec4d7a=this['_handlers']['get'](_0x2033fb['eventName']);_0xec4d7a&&await _0xec4d7a(_0x2033fb['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x2375a0,_0x50e300,_0x871ed4){const _0x1630ef=_0x2375a0['getEventName'](_0x50e300,!0x0);this['listenTo'](_0x2375a0,_0x1630ef,async(_0x341359,_0x3e0d2f)=>{const _0xa92e4a=_0x341359['name'];this['_eventsQueue']['push']({'eventName':_0xa92e4a,'data':_0x3e0d2f}),await this['_runQueue']();}),this['_handlers']['set'](_0x1630ef,_0x871ed4);}}exports['default']=SessionCollection;