/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x78ae67){return _0x78ae67&&_0x78ae67['__esModule']?_0x78ae67:{'default':_0x78ae67};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['_SERVICE']=void 0x0;const uuid_1=require('uuid'),utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),sessions_1=__importDefault(require('./../sessions/sessions')),collaborativeeditingconnectmessage_1=__importDefault(require('./messages/collaborativeeditingconnectmessage')),collaborativeeditingupdatemessage_1=__importDefault(require('./messages/collaborativeeditingupdatemessage')),collaborativeeditingreconnectmessage_1=__importDefault(require('./messages/collaborativeeditingreconnectmessage')),collaborativeeditingresponse_1=__importDefault(require('./responses/collaborativeeditingresponse')),collaborativeeditingconnectresponse_1=__importDefault(require('./responses/collaborativeeditingconnectresponse')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError')),getdocumentdetailsresponse_1=__importDefault(require('./responses/getdocumentdetailsresponse')),getdocumentdetailsmessage_1=__importDefault(require('./messages/getdocumentdetailsmessage'));exports['_SERVICE']=0x1;class CollaborativeEditingService{constructor(_0x4a4f04,_0x39a422){if(!_0x4a4f04)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x39a422?_0x39a422:(0x0,uuid_1['v4'])(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x4a4f04;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x9bbcbe,_0x163da4={'buffers':[],'types':[]},_0xfde0b0){const _0x343a94=new collaborativeeditingconnectmessage_1['default'](this['getId'](),_0x163da4['buffers'],_0x163da4['types'],this['_bundleVersion'],_0xfde0b0);return this['_connect'](_0x9bbcbe,_0x343a94);}['reconnect'](_0x698588,_0x81c8b4){if(this['isConnected']())throw new ckeditorcloudserviceserror_1['default']('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x698588);return this['_connect'](_0x698588,new collaborativeeditingreconnectmessage_1['default'](this['getId'](),_0x81c8b4,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x164230=new getdocumentdetailsmessage_1['default'](this['getId']());if(!this['_wsGateway'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x2cd895=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],getdocumentdetailsmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x164230));return messagescompressor_1['default']['decode'](_0x2cd895,getdocumentdetailsresponse_1['default']);}async['sendOperations'](_0x4771b4,_0xe95f9a,_0x552ed4){if(!_0x4771b4||!_0x4771b4['types']||!_0x4771b4['types']['length'])throw new ckeditorcloudserviceserror_1['default']('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x217693='number'==typeof _0xe95f9a?_0xe95f9a:parseInt(_0xe95f9a);if(!Number['isInteger'](_0x217693)||_0x217693<0x0)throw new ckeditorcloudserviceserror_1['default']('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x4befdf=new collaborativeeditingupdatemessage_1['default'](this['getId'](),_0x4771b4['buffers'],_0x4771b4['types'],_0x217693,[],_0x552ed4);if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x3cd350=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],collaborativeeditingupdatemessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x4befdf));return messagescompressor_1['default']['decode'](_0x3cd350,collaborativeeditingresponse_1['default']);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await sessions_1['default']['getConnectedSessions'](this['_wsGateway'],this['_id'],exports['_SERVICE'])),this['_connectedSessions'];}static['getConnectedSessions'](_0x37ed10,_0x1f7628){return sessions_1['default']['getConnectedSessions'](_0x37ed10,_0x1f7628,exports['_SERVICE']);}async['_connect'](_0x2cd6f7,_0x521e39){if(this['isConnected']())return;if(_0x2cd6f7['state']!==websocketgateway_1['default']['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x2cd6f7);this['_wsGateway']=_0x2cd6f7,this['stopListening'](_0x2cd6f7,'change:state');const _0x134737=await _0x2cd6f7['_sendRequest'](exports['_SERVICE'],_0x521e39['constructor']['TYPE'],messagescompressor_1['default']['encode'](_0x521e39)),_0x379f50=messagescompressor_1['default']['decode'](_0x134737,collaborativeeditingconnectresponse_1['default']);return this['listenTo'](_0x2cd6f7,'change:state',(_0x12f511,_0x57fd8c,_0x2b48a8)=>this['_onWsGatewayStateChange'](_0x2b48a8),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x2cd6f7,_0x379f50['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x379f50;}['_connectToChannel'](_0x318563,_0x149a36){this['_channel']=_0x318563['_getChannel'](exports['_SERVICE'],_0x149a36),this['listenTo'](this['_channel'],this['_channel']['getEventName'](collaborativeeditingupdatemessage_1['default']['TYPE']),(_0x1e4767,_0x1612fa)=>{const _0x5bc717=messagescompressor_1['default']['decode'](_0x1612fa,collaborativeeditingupdatemessage_1['default']);this['fire']('operationsReceived',_0x5bc717['baseVersion'],_0x5bc717['data'],_0x5bc717['metadata']);});}['_onWsGatewayStateChange'](_0x39fc90){_0x39fc90===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=exports['_SERVICE'],(0x0,utils_1['mix'])(CollaborativeEditingService,utils_1['EmitterMixin']),exports['default']=CollaborativeEditingService;