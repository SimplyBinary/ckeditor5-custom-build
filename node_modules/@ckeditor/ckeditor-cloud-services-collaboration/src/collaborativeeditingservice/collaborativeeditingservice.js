/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x414897){return _0x414897&&_0x414897['__esModule']?_0x414897:{'default':_0x414897};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const uuid_1=require('uuid'),utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),sessions_1=__importDefault(require('./../sessions/sessions')),collaborativeeditingconnectmessage_1=__importDefault(require('./messages/collaborativeeditingconnectmessage')),collaborativeeditingupdatemessage_1=__importDefault(require('./messages/collaborativeeditingupdatemessage')),collaborativeeditingreconnectmessage_1=__importDefault(require('./messages/collaborativeeditingreconnectmessage')),collaborativeeditingresponse_1=__importDefault(require('./responses/collaborativeeditingresponse')),collaborativeeditingconnectresponse_1=__importDefault(require('./responses/collaborativeeditingconnectresponse')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError')),getdocumentdetailsresponse_1=__importDefault(require('./responses/getdocumentdetailsresponse')),getdocumentdetailsmessage_1=__importDefault(require('./messages/getdocumentdetailsmessage'));exports['_SERVICE']=0x1;class CollaborativeEditingService{constructor(_0x5da23e,_0x3a3c00){if(!_0x5da23e)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x3a3c00?_0x3a3c00:uuid_1['v4'](),this['_isConnected']=!0x1,this['_bundleVersion']=_0x5da23e;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x5544e4,_0x2e6147={'buffers':[],'types':[]},_0x14b552){const _0x4b91dd=new collaborativeeditingconnectmessage_1['default'](this['getId'](),_0x2e6147['buffers'],_0x2e6147['types'],this['_bundleVersion'],_0x14b552);return this['_connect'](_0x5544e4,_0x4b91dd);}['reconnect'](_0x4945d5,_0x389935){if(this['isConnected']())throw new ckeditorcloudserviceserror_1['default']('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x4945d5);return this['_connect'](_0x4945d5,new collaborativeeditingreconnectmessage_1['default'](this['getId'](),_0x389935,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x3a7ffd=new getdocumentdetailsmessage_1['default'](this['getId']());if(!this['_wsGateway'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x31102b=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],getdocumentdetailsmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x3a7ffd));return messagescompressor_1['default']['decode'](_0x31102b,getdocumentdetailsresponse_1['default']);}async['sendOperations'](_0x1e3b87,_0x3600f5,_0x142efd){if(!_0x1e3b87||!_0x1e3b87['types']||!_0x1e3b87['types']['length'])throw new ckeditorcloudserviceserror_1['default']('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x4383ec='number'==typeof _0x3600f5?_0x3600f5:parseInt(_0x3600f5);if(!Number['isInteger'](_0x4383ec)||_0x4383ec<0x0)throw new ckeditorcloudserviceserror_1['default']('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x1c96c1=new collaborativeeditingupdatemessage_1['default'](this['getId'](),_0x1e3b87['buffers'],_0x1e3b87['types'],_0x4383ec,[],_0x142efd);if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x5c3752=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],collaborativeeditingupdatemessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x1c96c1));return messagescompressor_1['default']['decode'](_0x5c3752,collaborativeeditingresponse_1['default']);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await sessions_1['default']['getConnectedSessions'](this['_wsGateway'],this['_id'],exports['_SERVICE'])),this['_connectedSessions'];}static['getConnectedSessions'](_0xe7a04d,_0x332ad6){return sessions_1['default']['getConnectedSessions'](_0xe7a04d,_0x332ad6,exports['_SERVICE']);}async['_connect'](_0x124de3,_0x14b218){if(this['isConnected']())return;if(_0x124de3['state']!==websocketgateway_1['default']['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x124de3);this['_wsGateway']=_0x124de3,this['stopListening'](_0x124de3,'change:state');const _0x408322=await _0x124de3['_sendRequest'](exports['_SERVICE'],_0x14b218['constructor']['TYPE'],messagescompressor_1['default']['encode'](_0x14b218)),_0x5ba888=messagescompressor_1['default']['decode'](_0x408322,collaborativeeditingconnectresponse_1['default']);return this['listenTo'](_0x124de3,'change:state',(_0x5444e1,_0x1adab0,_0x451ae3)=>this['_onWsGatewayStateChange'](_0x451ae3),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x124de3,_0x5ba888['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x5ba888;}['_connectToChannel'](_0x5fd3ba,_0x240787){this['_channel']=_0x5fd3ba['_getChannel'](exports['_SERVICE'],_0x240787),this['listenTo'](this['_channel'],this['_channel']['getEventName'](collaborativeeditingupdatemessage_1['default']['TYPE']),(_0x249afa,_0x4b0473)=>{const _0x3a759a=messagescompressor_1['default']['decode'](_0x4b0473,collaborativeeditingupdatemessage_1['default']);this['fire']('operationsReceived',_0x3a759a['baseVersion'],_0x3a759a['data'],_0x3a759a['metadata']);});}['_onWsGatewayStateChange'](_0x19db63){_0x19db63===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=exports['_SERVICE'],utils_1['mix'](CollaborativeEditingService,utils_1['EmitterMixin']),exports['default']=CollaborativeEditingService;