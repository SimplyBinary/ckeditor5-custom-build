/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var _a,__importDefault=this&&this['__importDefault']||function(_0x5c21d5){return _0x5c21d5&&_0x5c21d5['__esModule']?_0x5c21d5:{'default':_0x5c21d5};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),'E2E_TEST_WINDOW'===(null===(_a=global['window'])||void 0x0===_a?void 0x0:_a['type'])&&(global['window']=void 0x0);const socket_io_client_1=require('socket.io-client'),url_parse_1=__importDefault(require('url-parse')),utils_1=require('ckeditor5/src/utils'),channel_1=__importDefault(require('./channel')),user_1=__importDefault(require('./../users/user')),version_1=__importDefault(require('./../version')),ckeditorcloudserviceserror_1=__importDefault(require('./../ckeditorcloudserviceserror')),parser_1=require('./parser/parser'),requestsmanager_1=__importDefault(require('./requestsmanager'));var WEB_SOCKET_GATEWAY_STATES;!function(_0x2348a1){_0x2348a1['DISCONNECTED']='disconnected',_0x2348a1['CONNECTING']='connecting',_0x2348a1['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES=exports['WEB_SOCKET_GATEWAY_STATES']||(exports['WEB_SOCKET_GATEWAY_STATES']={}));class WebSocketGateway{constructor(_0x294d4a,_0x40a2e3,_0x3a2792={},_0x546622=socket_io_client_1['io'],_0xb5ed59=user_1['default']['get']){if(this['_token']=_0x40a2e3,this['_options']=_0x3a2792,this['_connectionProvider']=_0x546622,this['_userFactory']=_0xb5ed59,this['_requestsManager']=new requestsmanager_1['default'](this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x294d4a)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x2710),this['_url']=url_parse_1['default'](_0x294d4a['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state','disconnected'),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x2c81e6,_0x15f198,_0x1e80b5)=>{var _0x5c4c3b;if(_0x1e80b5!==WebSocketGateway['STATE_CONNECTED']){if(_0x1e80b5===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](user_1['default'],this,null===(_0x5c4c3b=this['_socketAuth'])||void 0x0===_0x5c4c3b?void 0x0:_0x5c4c3b['userId']);}catch(_0x156b93){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x40a48c,_0x33f385)=>{this['_options']['onError']?this['_options']['onError'](_0x33f385):console['log'](_0x33f385);});}get['sessionId'](){return this['socketId'];}['disconnect'](){var _0xff43dd;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0xff43dd=this['_socket'])||void 0x0===_0xff43dd||_0xff43dd['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x3b34b9,_0x38dcf8='local.cs.dev:443/ws-v2',_0x59c293={},_0x1ced85=socket_io_client_1['io'],_0x451d22=user_1['default']['get']){const _0x11af12=new WebSocketGateway(_0x38dcf8,_0x3b34b9,_0x59c293,_0x1ced85,_0x451d22);return await _0x11af12['_connect'](),_0x11af12;}['_sendRequest'](_0x98a423,_0x9e4526,_0xb015bd){if(!_0x98a423)throw new ckeditorcloudserviceserror_1['default']('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new ckeditorcloudserviceserror_1['default']('Not\x20authenticated.',this);const _0x2e1dbd=new ArrayBuffer(_0xb015bd['length']+0x2),_0xd5760d=new Uint8Array(_0x2e1dbd);return _0xd5760d[0x0]=_0x98a423,_0xd5760d[0x1]=parseInt(_0x9e4526),_0xd5760d['set'](_0xb015bd,0x2),this['_emit'](0x1,_0xd5760d);}['_getChannel'](_0x4aa988,_0x57f1ad){const _0x53ac1e=''+_0x4aa988+_0x57f1ad;return!this['_channels']['has'](_0x53ac1e)&&this['_socket']&&this['_channels']['set'](_0x53ac1e,new channel_1['default'](_0x53ac1e,this,this['_socket'])),this['_channels']['get'](_0x53ac1e);}['_connect'](){return new Promise((_0x54cce5,_0x42fc29)=>{const _0x18f923=this['_setupSocket']();!this['socketId']&&_0x18f923['io']['on']('reconnect_error',()=>{this['_reconnectionAttemptError'](_0x42fc29);}),_0x18f923['once']('connect',async()=>{try{await this['_onConnect'](),_0x54cce5();}catch(_0x592176){_0x42fc29(_0x592176);}}),_0x18f923['connect']();});}['_setupSocket'](){var _0x1eba2a;if(this['_socket'])return this['_socket'];const _0x2475da=this['_url']['port']||('http:'===this['_url']['protocol']?0x50:0x1bb),_0xb568d7=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x2475da,_0x47306e=this['_connectionProvider'](_0xb568d7,{'parser':{'Encoder':parser_1['Encoder'],'Decoder':parser_1['Decoder']},'path':'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':version_1['default']},'agent':null!==(_0x1eba2a=this['_options']['agent'])&&void 0x0!==_0x1eba2a&&_0x1eba2a});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x47306e['on']('connect',()=>{this['socketId']=_0x47306e['id'];}),_0x47306e['on']('connect_error',this['_onError']['bind'](this)),_0x47306e['on']('disconnect',this['_onDisconnect']['bind'](this)),_0x47306e['io']['on']('reconnect',this['_onReconnect']['bind'](this)),_0x47306e['io']['on']('reconnect_attempt',_0x5e543b=>{this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x5e543b;}),_0x47306e['on']('unauthorized',this['_onUnauthorized']['bind'](this)),this['_socket']=_0x47306e,_0x47306e;}['_emit'](_0x480713,_0x4e26e8){const _0x1405c7=this['_socket'];return this['_requestsManager']['send'](_0x13f39d=>{_0x1405c7['emit'](_0x480713,_0x4e26e8,(_0x36cd92,_0x792e7)=>{if(_0x36cd92)return _0x13f39d['error'](ckeditorcloudserviceserror_1['default']['fromPublicError'](_0x36cd92,this));_0x13f39d['response'](_0x792e7);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x4dc0aa,_0x34ab77){this['_socketAuth']={'environmentId':_0x4dc0aa,'userId':_0x34ab77,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x426374=async(_0xf9be0c,_0x55abd2,_0x5e20c4)=>{try{await this['_authenticate'](_0x5e20c4);}catch(_0x4a7c13){}};this['_token']['on']('change:value',_0x426374),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x426374);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x34dcc3 of this['_channels']['values']())_0x34dcc3['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_onError'](_0x5bf8f9){this['fire']('error',new ckeditorcloudserviceserror_1['default'](_0x5bf8f9['message'],this,_0x5bf8f9['code']));}['_reconnectionAttemptError'](_0x1f1871){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x1f1871(new ckeditorcloudserviceserror_1['default']('The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.')));}['_onUnauthorized']({error:error}){this['_removeAuthData'](),this['fire']('error',ckeditorcloudserviceserror_1['default']['fromPublicError'](error,this));}async['_authenticate'](_0xb55204){try{const _0x37677e=await this['_emit'](0x2,{'token':_0xb55204});this['_addAuthData'](_0x37677e['environmentId'],_0x37677e['userId']);}catch(_0xf1a8e1){throw this['_removeAuthData'](),_0xf1a8e1;}}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=utils_1['priorities']['get']('highest')+0xf423f,utils_1['mix'](WebSocketGateway,utils_1['ObservableMixin']),exports['default']=WebSocketGateway;