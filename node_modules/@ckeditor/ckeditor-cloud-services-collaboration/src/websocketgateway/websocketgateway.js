/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0xc93b72){return _0xc93b72&&_0xc93b72['__esModule']?_0xc93b72:{'default':_0xc93b72};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['WEB_SOCKET_GATEWAY_STATES']=void 0x0;const socket_io_client_1=require('socket.io-client'),url_parse_1=__importDefault(require('url-parse')),utils_1=require('ckeditor5/src/utils'),channel_1=__importDefault(require('./channel')),user_1=__importDefault(require('./../users/user')),version_1=__importDefault(require('./../version')),ckeditorcloudserviceserror_1=__importDefault(require('./../ckeditorcloudserviceserror')),parser_1=require('./parser/parser'),requestsmanager_1=__importDefault(require('./requestsmanager'));var WEB_SOCKET_GATEWAY_STATES;!function(_0x38f60e){_0x38f60e['DISCONNECTED']='disconnected',_0x38f60e['CONNECTING']='connecting',_0x38f60e['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES=exports['WEB_SOCKET_GATEWAY_STATES']||(exports['WEB_SOCKET_GATEWAY_STATES']={}));class WebSocketGateway{constructor(_0x71a585,_0x260d71,_0x49bdf5={},_0xff3e5e=socket_io_client_1['io'],_0x21cd39=user_1['default']['get']){if(this['_token']=_0x260d71,this['_options']=_0x49bdf5,this['_connectionProvider']=_0xff3e5e,this['_userFactory']=_0x21cd39,this['_requestsManager']=new requestsmanager_1['default'](this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x71a585)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x2710),this['_url']=(0x0,url_parse_1['default'])(_0x71a585['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state','disconnected'),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x8b310c,_0x1837fa,_0x4cbb6a)=>{var _0x5c6b8a;if(_0x4cbb6a!==WebSocketGateway['STATE_CONNECTED']){if(_0x4cbb6a===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](user_1['default'],this,null===(_0x5c6b8a=this['_socketAuth'])||void 0x0===_0x5c6b8a?void 0x0:_0x5c6b8a['userId']);}catch(_0x4b2e89){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x31fa97,_0x268954)=>{this['_options']['onError']?this['_options']['onError'](_0x268954):console['log'](_0x268954);});}get['sessionId'](){return this['socketId'];}['disconnect'](){var _0x37bfc2;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x37bfc2=this['_socket'])||void 0x0===_0x37bfc2||_0x37bfc2['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x3cb5b2,_0x2a5667='local.cs.dev:443/ws-v2',_0x5bf17e={},_0x1523b1=socket_io_client_1['io'],_0x2623f5=user_1['default']['get']){const _0x22cc3c=new WebSocketGateway(_0x2a5667,_0x3cb5b2,_0x5bf17e,_0x1523b1,_0x2623f5);return await _0x22cc3c['_connect'](),_0x22cc3c;}['_sendRequest'](_0x203327,_0x73c1a,_0x265439){if(!_0x203327)throw new ckeditorcloudserviceserror_1['default']('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new ckeditorcloudserviceserror_1['default']('Not\x20authenticated.',this);const _0x58d45f=new ArrayBuffer(_0x265439['length']+0x2),_0x4ff9f4=new Uint8Array(_0x58d45f);return _0x4ff9f4[0x0]=_0x203327,_0x4ff9f4[0x1]=parseInt(_0x73c1a),_0x4ff9f4['set'](_0x265439,0x2),this['_emit'](0x1,_0x4ff9f4);}['_getChannel'](_0x26d4d2,_0x1236ee){const _0x4bb676=''+_0x26d4d2+_0x1236ee;return!this['_channels']['has'](_0x4bb676)&&this['_socket']&&this['_channels']['set'](_0x4bb676,new channel_1['default'](_0x4bb676,this,this['_socket'])),this['_channels']['get'](_0x4bb676);}['_connect'](){return new Promise((_0x22e32c,_0x189c68)=>{const _0x4235e2=this['_setupSocket']();!this['socketId']&&_0x4235e2['io']['on']('reconnect_error',()=>{this['_reconnectionAttemptError'](_0x189c68);}),_0x4235e2['once']('connect',async()=>{try{await this['_onConnect'](),_0x22e32c();}catch(_0x2748e2){_0x189c68(_0x2748e2);}}),_0x4235e2['connect']();});}['_setupSocket'](){var _0x4ea003;if(this['_socket'])return this['_socket'];const _0x280f18=this['_url']['port']||('http:'===this['_url']['protocol']?0x50:0x1bb),_0x36592d=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x280f18,_0x250f02=this['_connectionProvider'](_0x36592d,{'parser':{'Encoder':parser_1['Encoder'],'Decoder':parser_1['Decoder']},'path':'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':version_1['default']},'agent':null!==(_0x4ea003=this['_options']['agent'])&&void 0x0!==_0x4ea003&&_0x4ea003});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x250f02['on']('connect',()=>{this['socketId']=_0x250f02['id'];}),_0x250f02['on']('connect_error',this['_onError']['bind'](this)),_0x250f02['on']('disconnect',this['_onDisconnect']['bind'](this)),_0x250f02['io']['on']('reconnect',this['_onReconnect']['bind'](this)),_0x250f02['io']['on']('reconnect_attempt',_0xefef14=>{this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0xefef14;}),_0x250f02['on']('unauthorized',this['_onUnauthorized']['bind'](this)),this['_socket']=_0x250f02,_0x250f02;}['_emit'](_0x4fc860,_0x1862c7){const _0x3757bc=this['_socket'];return this['_requestsManager']['send'](_0x102f88=>{_0x3757bc['emit'](_0x4fc860,_0x1862c7,(_0x47e641,_0x591837)=>{if(_0x47e641)return _0x102f88['error'](ckeditorcloudserviceserror_1['default']['fromPublicError'](_0x47e641,this));_0x102f88['response'](_0x591837);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x269cb3,_0x2d327a){this['_socketAuth']={'environmentId':_0x269cb3,'userId':_0x2d327a,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x22d3df=async(_0x81c2c7,_0x385930,_0x57970a)=>{try{await this['_authenticate'](_0x57970a);}catch(_0x38c068){}};this['_token']['on']('change:value',_0x22d3df),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x22d3df);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x4f1d7d of this['_channels']['values']())_0x4f1d7d['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_onError'](_0x42be0f){console['warn']('Connection\x20to\x20WebSocket\x20server\x20failed.\x20Details:\x20',{'originalError':_0x42be0f});}['_reconnectionAttemptError'](_0x1b9f35){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x1b9f35(new ckeditorcloudserviceserror_1['default']('The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.')));}['_onUnauthorized']({error:error}){this['_removeAuthData'](),this['fire']('error',ckeditorcloudserviceserror_1['default']['fromPublicError'](error,this));}async['_authenticate'](_0x11d3a3){try{const _0x23d368=await this['_emit'](0x2,{'token':_0x11d3a3});this['_addAuthData'](_0x23d368['environmentId'],_0x23d368['userId']);}catch(_0x19d598){throw this['_removeAuthData'](),_0x19d598;}}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=utils_1['priorities']['get']('highest')+0xf423f,(0x0,utils_1['mix'])(WebSocketGateway,utils_1['ObservableMixin']),exports['default']=WebSocketGateway;