/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x123535){return _0x123535&&_0x123535['__esModule']?_0x123535:{'default':_0x123535};},__importStar=this&&this['__importStar']||function(_0x7c5437){if(_0x7c5437&&_0x7c5437['__esModule'])return _0x7c5437;var _0x186ef8={};if(null!=_0x7c5437)for(var _0x5ae939 in _0x7c5437)Object['hasOwnProperty']['call'](_0x7c5437,_0x5ae939)&&(_0x186ef8[_0x5ae939]=_0x7c5437[_0x5ae939]);return _0x186ef8['default']=_0x7c5437,_0x186ef8;};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),addsuggestionmessage_1=__importDefault(require('./messages/addsuggestionmessage')),addsuggestionresponse_1=__importDefault(require('./responses/addsuggestionresponse')),getsuggestionmessage_1=__importDefault(require('./messages/getsuggestionmessage')),getsuggestionresponse_1=__importDefault(require('./responses/getsuggestionresponse')),getallsuggestionsmessage_1=__importDefault(require('./messages/getallsuggestionsmessage')),getallsuggestionsresponse_1=__importDefault(require('./responses/getallsuggestionsresponse')),updatesuggestionmessage_1=__importDefault(require('./messages/updatesuggestionmessage')),connectmessage_1=__importDefault(require('./messages/connectmessage')),connectresponse_1=__importDefault(require('./responses/connectresponse')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),websocketgateway_1=__importStar(require('../websocketgateway/websocketgateway')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError'));exports['_SERVICE']=0xa;class TrackChangesService{constructor(_0x1996ba){this['_documentId']=_0x1996ba,this['_isConnected']=!0x1;}get['isConnected'](){return this['_isConnected'];}async['connect'](_0x8d6fc3){if(this['_isConnected'])return;if(_0x8d6fc3['state']!==websocketgateway_1['WEB_SOCKET_GATEWAY_STATES']['CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x8d6fc3);const _0x47eb51=new connectmessage_1['default'](this['_documentId']);this['_wsGateway']=_0x8d6fc3,this['stopListening'](_0x8d6fc3,'change:state');const _0x47d3f8=await _0x8d6fc3['_sendRequest'](exports['_SERVICE'],connectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x47eb51)),_0x4ad982=messagescompressor_1['default']['decode'](_0x47d3f8,connectresponse_1['default']);return this['listenTo'](_0x8d6fc3,'change:state',(_0x2c43d4,_0x2f6cb2,_0x27c0c3)=>this['_onWsGatewayStateChange'](_0x27c0c3),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x8d6fc3,_0x4ad982['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x4ad982['suggestions'];}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['add'](_0xa78c80,_0x4a1a5e,_0x271c5f,_0x54bcc9=null,_0x5f3e71){const _0x549b89=new addsuggestionmessage_1['default'](_0xa78c80,this['_documentId'],_0x4a1a5e,_0x271c5f,_0x54bcc9,_0x5f3e71),_0x198483=await this['_sendRequest'](addsuggestionmessage_1['default']['TYPE'],_0x549b89);return messagescompressor_1['default']['decode'](_0x198483,addsuggestionresponse_1['default']);}async['get'](_0x586244,_0x13ce62=0x1){const _0x20bb37=new getsuggestionmessage_1['default'](_0x586244,this['_documentId']);try{const _0x3faa88=await this['_sendRequest'](getsuggestionmessage_1['default']['TYPE'],_0x20bb37);return messagescompressor_1['default']['decode'](_0x3faa88,getsuggestionresponse_1['default']);}catch(_0x4069d8){if(_0x4069d8 instanceof ckeditorcloudserviceserror_1['default']&&'404'===_0x4069d8['code']&&_0x13ce62<0x5)return await(_0x4e1e43=0x64*_0x13ce62,new Promise(_0x2275b3=>{setTimeout(_0x2275b3,_0x4e1e43);})),this['get'](_0x586244,_0x13ce62+0x1);if(_0x4069d8 instanceof ckeditorcloudserviceserror_1['default'])throw _0x4069d8;throw new ckeditorcloudserviceserror_1['default'](_0x4069d8['message'],this['_wsGateway']);}var _0x4e1e43;}async['getAll'](){const _0x574d0a=new getallsuggestionsmessage_1['default'](this['_documentId']),_0x54465c=await this['_sendRequest'](getallsuggestionsmessage_1['default']['TYPE'],_0x574d0a),{suggestions:suggestions}=messagescompressor_1['default']['decode'](_0x54465c,getallsuggestionsresponse_1['default']);return suggestions;}async['update'](_0x14325f,_0x5b17cf={}){const {hasComments:hasComments,state:state,attributes:attributes}=_0x5b17cf,_0x2af302=void 0x0!==hasComments,_0x3389c6=new updatesuggestionmessage_1['default'](_0x14325f,this['_documentId'],hasComments,_0x2af302,state,attributes);await this['_sendRequest'](updatesuggestionmessage_1['default']['TYPE'],_0x3389c6);}['_connectToChannel'](_0x35b26a,_0x5883d8){this['_channel']=_0x35b26a['_getChannel'](TrackChangesService['_SERVICE'],_0x5883d8),this['_channel']&&this['listenTo'](this['_channel'],this['_channel']['getEventName'](updatesuggestionmessage_1['default']['TYPE']),(_0x55d359,_0x684ee2)=>{const _0x5afe2b=messagescompressor_1['default']['decode'](_0x684ee2,updatesuggestionmessage_1['default']);this['fire']('suggestionUpdated',_0x5afe2b);});}['_onWsGatewayStateChange'](_0x54a468){_0x54a468===websocketgateway_1['WEB_SOCKET_GATEWAY_STATES']['DISCONNECTED']&&this['disconnect']();}['_sendRequest'](_0x21e985,_0x14cf32){if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Track\x20Changes',this);return this['_wsGateway']['_sendRequest'](exports['_SERVICE'],_0x21e985,messagescompressor_1['default']['encode'](_0x14cf32));}}TrackChangesService['_SERVICE']=exports['_SERVICE'],utils_1['mix'](TrackChangesService,utils_1['EmitterMixin']),exports['default']=TrackChangesService;