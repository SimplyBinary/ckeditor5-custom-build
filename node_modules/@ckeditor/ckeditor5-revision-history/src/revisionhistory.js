/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Plugin as _0x26cd4c}from'ckeditor5/src/core';import{CKEditorError as _0x3a0bb6,uid as _0x34f956}from'ckeditor5/src/utils';import _0x401acf from'./revisiontracker';import _0x3aa691 from'./ui/revisionhistory/revisionhistoryui';import _0x5739de from'./revisionviewer';import _0x59aab6 from'./ui/revisionviewer/revisionviewerui';import _0xf8236a from'./ui/revisionssidebar/revisionssidebar';import _0x27f8ba from'./editor/revisionviewereditor';const m=['RevisionTracker','RevisionHistoryUI','WebSocketGateway','CommentsRepository','TrackChangesEditing','RestrictedEditingMode','Autosave'];export default class g extends _0x26cd4c{static get['pluginName'](){return'RevisionHistory';}static get['requires'](){return[_0x401acf,_0x3aa691];}constructor(..._0x466626){if(super(..._0x466626),!this['editor']['config']['get']('revisionHistory'))throw new _0x3a0bb6('revision-history-missing-configuration',this);this['_viewerEditor']=null,this['editor']['config']['define']('revisionHistory.showRevisionViewerCallback',_0x2f7f87=>this['_showRevisionViewer'](_0x2f7f87)),this['editor']['config']['define']('revisionHistory.closeRevisionViewerCallback',_0x1125ee=>this['_closeRevisionViewer'](_0x1125ee)),this['editor']['config']['define']('revisionHistory.restoreRevisionCallback',_0x25ffd6=>this['_restoreRevision'](_0x25ffd6)),this['_enhanceShowRevisionViewerCallback'](),this['_enhanceCloseRevisionViewerCallback']();}set['adapter'](_0x2f58ad){this['editor']['plugins']['get']('RevisionTracker')['adapter']=_0x2f58ad;}get['adapter'](){return this['editor']['plugins']['get']('RevisionTracker')['adapter'];}['addRevisionData'](..._0x35e059){return this['editor']['plugins']['get']('RevisionTracker')['addRevisionData'](..._0x35e059);}['getRevision'](..._0x57fca2){return this['editor']['plugins']['get']('RevisionsRepository')['getRevision'](..._0x57fca2);}['getRevisions'](..._0xf8ab2){return this['editor']['plugins']['get']('RevisionsRepository')['getRevisions'](..._0xf8ab2);}['_getRevisionViewerEditorConfig'](){const _0x3d3270={},_0x27d851=this['editor'],_0x503b46=_0x27d851['plugins']['get']('RevisionTracker'),_0x4dbfb6=_0x27d851['plugins']['get']('Users')['users'];for(const _0x564fac of _0x27d851['config']['names']())_0x3d3270[_0x564fac]=_0x27d851['config']['get'](_0x564fac);delete _0x3d3270['context'],_0x3d3270['initialData']='',_0x3d3270['toolbar']=['exitToEditing','restoreRevision','changesNavigation'];const _0x21cf0e=this['editor']['constructor']['builtinPlugins']||[],_0x3eb305=_0x3d3270['extraPlugins']||[];delete _0x3d3270['extraPlugins'];const _0x3446fb=_0x21cf0e['concat'](_0x3d3270['plugins'])['concat'](_0x3eb305)['map'](_0x596dfd=>'string'==typeof _0x596dfd?_0x21cf0e['find'](_0x5bf14f=>_0x5bf14f['pluginName']==_0x596dfd):_0x596dfd);return _0x3d3270['plugins']=Array['from'](new Set(_0x3446fb))['filter'](_0x506026=>k(_0x506026,_0x27d851['plugins'],[])),(_0x3d3270['plugins']['push'](_0x5739de,_0x59aab6,class extends _0x26cd4c{static get['requires'](){return[_0x5739de,'Users'];}['init'](){const _0x277b59=this['editor']['plugins']['get']('Users');for(const _0x5150be of _0x4dbfb6)_0x5150be['isAnonymous']||_0x277b59['getUser'](_0x5150be['id'])||_0x277b59['addUser'](_0x5150be);const _0x44dd80=_0x503b46['repository']['getRevisions']();let _0x1db798=null;const _0x5992a4=this['editor']['plugins']['get']('RevisionViewer');_0x5992a4['adapter']=_0x503b46['adapter'],_0x5992a4['bind']('isEnabled')['to'](_0x503b46),this['editor']['commands']['get']('restoreRevision')['bind']('isEnabled')['to'](_0x27d851,'isReadOnly',_0x4fd38a=>!_0x4fd38a);for(const _0x49eb69 of _0x44dd80){const _0x25a995=null===_0x49eb69['creator'];if(_0x25a995&&_0x49eb69['toVersion']===_0x49eb69['fromVersion'])continue;const _0x3335e7=_0x49eb69['toJSON']();_0x5992a4['addRevisionData'](_0x3335e7,(_0x126dfc,_0xbd110f,_0x1f1150)=>{if(_0x25a995){if(_0x1db798)_0x1db798['_update'](_0x126dfc,_0xbd110f);else{if(!_0xbd110f){const _0x318ea9=_0x1f1150['toJSON']();_0x318ea9['id']=_0x34f956(),_0x503b46['saveRevision'](_0x318ea9,_0x1f1150['toVersion'])['then'](_0x5a4afe=>{_0x1db798=_0x5a4afe;});}}}else _0x49eb69['_update'](_0x126dfc,_0xbd110f);});}}},_0xf8236a),_0x3d3270);}['_enhanceShowRevisionViewerCallback'](){const _0x11f64e=this['editor']['config']['get']('revisionHistory')['showRevisionViewerCallback'];this['editor']['config']['set']('revisionHistory.showRevisionViewerCallback',async()=>{this['editor']['enableReadOnlyMode']('revision-history-viewer-opened');const _0x2b5386=this['editor']['plugins']['get']('RevisionTracker');this['editor']['plugins']['has']('Autosave')?await this['editor']['plugins']['get']('Autosave')['save']():await _0x2b5386['update'](),this['editor']['plugins']['has']('PaginationLookup')&&this['editor']['plugins']['get']('PaginationLookup')['_recalculatePageBreaks']();const _0xec5b19=this['_getRevisionViewerEditorConfig']();return _0x11f64e(_0xec5b19)['then'](_0x50fc37=>{this['_viewerEditor']=_0x50fc37,this['editor']['plugins']['has']('Annotations')&&this['editor']['plugins']['get']('Annotations')['refreshVisibility']();})['catch'](_0x733fc7=>{console['error'](_0x733fc7),this['editor']['isReadOnly']=!0x1;});});}['_enhanceCloseRevisionViewerCallback'](){const _0x263ef1=this['editor']['config']['get']('revisionHistory')['closeRevisionViewerCallback'];this['editor']['config']['set']('revisionHistory.closeRevisionViewerCallback',()=>(this['editor']['plugins']['has']('PaginationLookup')&&this['editor']['plugins']['get']('PaginationLookup')['_recalculatePageBreaks'](),_0x263ef1(this['_viewerEditor'])['then'](()=>{this['editor']['disableReadOnlyMode']('revision-history-viewer-opened'),this['_viewerEditor']=null,this['editor']['plugins']['has']('Annotations')&&(this['editor']['plugins']['get']('Annotations')['refreshVisibility'](),this['editor']['plugins']['get']('Annotations')['refreshPositioning']());})));}['_showRevisionViewer'](_0x13ac28){const _0x2df1bc=this['editor']['config']['get']('revisionHistory.editorContainer'),_0x3311bf=this['editor']['config']['get']('revisionHistory.viewerContainer'),_0x26f233=this['editor']['config']['get']('revisionHistory.viewerEditorElement');return _0x27f8ba['create'](_0x26f233,_0x13ac28)['then'](_0x582c04=>(_0x3311bf['style']['display']='block',_0x2df1bc['style']['display']='none',_0x582c04));}['_closeRevisionViewer'](_0x32a78b){const _0x220ed8=this['editor']['config']['get']('revisionHistory.editorContainer');return this['editor']['config']['get']('revisionHistory.viewerContainer')['style']['display']='none',_0x220ed8['style']['display']='',_0x32a78b['destroy']();}async['_restoreRevision'](_0x3e87a8){const _0x410168=this['editor'],t=_0x410168['t'],_0x514e4b=this['_viewerEditor']['plugins']['get']('RevisionViewer'),_0x3bc37b=_0x410168['plugins']['get']('RevisionTracker'),_0x2d9bfb=_0x514e4b['repository']['getRevision'](_0x3e87a8);let _0x42eeeb,_0x4cf68b;try{_0x42eeeb=await _0x514e4b['getRevisionData'](_0x2d9bfb);}catch(_0x5be137){return void console['error'](_0x5be137);}_0x410168['model']['change'](_0x1cb0ad=>{for(const _0x57866a of Array['from'](_0x410168['model']['markers']['getMarkersGroup']('restrictedEditingException')))_0x1cb0ad['removeMarker'](_0x57866a);}),_0x514e4b['isReady']=!0x1,_0x410168['data']['set'](_0x42eeeb,{'suppressErrorInCollaboration':!0x0});const _0x9000d1=t('Restored');if(_0x2d9bfb['name'])_0x4cf68b=-0x1==_0x2d9bfb['name']['indexOf'](_0x9000d1)?_0x9000d1+':\x20'+_0x2d9bfb['name']:_0x2d9bfb['name'];else _0x4cf68b=_0x9000d1+':\x20'+(_0x2d9bfb['createdAt']['toLocaleDateString'](_0x410168['locale']['uiLanguage'],{'month':'long','day':'numeric'})+',\x20'+_0x2d9bfb['createdAt']['toLocaleTimeString'](_0x410168['locale']['uiLanguage'],{'hour':'numeric','minute':'numeric'}));return await _0x3bc37b['saveRevision']({'name':_0x4cf68b}),_0x514e4b['isReady']=!0x0,_0x410168['config']['get']('revisionHistory')['closeRevisionViewerCallback']();}}function k(_0x3a2de9,_0x1b550a,_0x3da7dd){const _0x5407cf='function'==typeof _0x3a2de9?_0x3a2de9['pluginName']||_0x3a2de9['name']:_0x3a2de9;if(_0x3da7dd['includes'](_0x5407cf))return!0x0;if(_0x3da7dd['push'](_0x5407cf),m['includes'](_0x5407cf))return!0x1;const _0x3f455d=(('function'==typeof _0x3a2de9?_0x3a2de9:_0x1b550a['has'](_0x5407cf)?_0x1b550a['get'](_0x5407cf):{})['requires']||[])['every'](_0x432e02=>k(_0x432e02,_0x1b550a,_0x3da7dd));return _0x3f455d||m['push'](_0x5407cf),_0x3f455d;}